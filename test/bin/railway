#!/usr/bin/env bun
import fs from "node:fs";
import path from "node:path";

const argv = stripGlobals(process.argv.slice(2));

if (argv[0] === "whoami") {
  console.log("test-user");
  process.exit(0);
}

if (argv[0] === "link") {
  const dir = path.join(process.cwd(), ".railway");
  fs.mkdirSync(dir, { recursive: true });
  fs.writeFileSync(
    path.join(dir, "config.json"),
    JSON.stringify({ projectId: "proj_test" }, null, 2),
    "utf8",
  );
  process.exit(0);
}

if (argv[0] === "variable" && argv[1] === "list") {
  const environment = readFlag(argv, "--environment") ?? "development";
  const store = readStore();
  const vars = store.env[environment] ?? {};
  const asArray = Object.entries(vars)
    .sort(([a], [b]) => a.localeCompare(b))
    .map(([name, value]) => ({ name, value }));

  if (argv.includes("--json")) {
    console.log(JSON.stringify(asArray, null, 2));
    process.exit(0);
  }

  for (const entry of asArray) {
    console.log(`${entry.name}=${entry.value}`);
  }
  process.exit(0);
}

if (argv[0] === "variable" && argv[1] === "set") {
  const pair = argv[2];
  const environment = readFlag(argv, "--environment") ?? "development";
  if (!pair || !pair.includes("=")) {
    console.error("Missing KEY=value");
    process.exit(1);
  }
  const eq = pair.indexOf("=");
  const key = pair.slice(0, eq);
  const value = pair.slice(eq + 1);

  const store = readStore();
  store.env[environment] ??= {};
  store.env[environment][key] = value;
  writeStore(store);
  process.exit(0);
}

if (argv[0] === "variable" && argv[1] === "delete") {
  const key = argv[2];
  const environment = readFlag(argv, "--environment") ?? "development";
  if (!key) {
    console.error("Missing variable name");
    process.exit(1);
  }

  const store = readStore();
  store.env[environment] ??= {};
  const exists = Object.prototype.hasOwnProperty.call(
    store.env[environment],
    key,
  );
  if (!exists) {
    console.error("Not found");
    process.exit(1);
  }

  delete store.env[environment][key];
  writeStore(store);
  process.exit(0);
}

console.error(`Unsupported fake railway invocation: ${argv.join(" ")}`);
process.exit(1);

function stripGlobals(args: string[]): string[] {
  const out: string[] = [];
  for (let i = 0; i < args.length; i += 1) {
    const token = args[i];
    if (!token) continue;
    if (token === "--service" || token === "-s") {
      i += 1;
      continue;
    }
    out.push(token);
  }
  return out;
}

function readFlag(args: string[], name: string): string | undefined {
  const idx = args.indexOf(name);
  if (idx === -1) return undefined;
  const value = args[idx + 1];
  return typeof value === "string" && value.length > 0 ? value : undefined;
}

function storePath(): string {
  return path.join(process.cwd(), ".better-env-test", "railway-store.json");
}

type Store = {
  env: Record<string, Record<string, string>>;
};

function readStore(): Store {
  const p = storePath();
  if (!fs.existsSync(p)) {
    return { env: {} };
  }
  const raw = fs.readFileSync(p, "utf8");
  const parsed = JSON.parse(raw);
  if (!isStore(parsed)) {
    return { env: {} };
  }
  return parsed;
}

function writeStore(store: Store): void {
  const dir = path.dirname(storePath());
  fs.mkdirSync(dir, { recursive: true });
  fs.writeFileSync(storePath(), JSON.stringify(store, null, 2), "utf8");
}

function isStore(value: unknown): value is Store {
  if (typeof value !== "object" || value === null) return false;
  if (!("env" in value)) return false;
  return true;
}
