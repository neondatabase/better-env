#!/usr/bin/env bun
import fs from "node:fs";
import path from "node:path";

const argv = stripGlobals(process.argv.slice(2));

if (argv[0] === "version") {
  console.log("flyctl v0.0.0-test");
  process.exit(0);
}

if (argv[0] === "auth" && argv[1] === "whoami") {
  console.log("test-user@example.com");
  process.exit(0);
}

if (argv[0] === "secrets" && argv[1] === "list") {
  const app = resolveApp(argv);
  if (!app) {
    console.error("No app specified");
    process.exit(1);
  }

  const store = readStore();
  const vars = store.apps[app]?.secrets ?? {};
  const out = Object.entries(vars)
    .sort(([a], [b]) => a.localeCompare(b))
    .map(([Name]) => ({ Name, Digest: "sha256:test" }));

  if (argv.includes("--json")) {
    console.log(JSON.stringify(out, null, 2));
    process.exit(0);
  }

  for (const row of out) {
    console.log(row.Name);
  }
  process.exit(0);
}

if (argv[0] === "secrets" && argv[1] === "set") {
  const app = resolveApp(argv);
  if (!app) {
    console.error("No app specified");
    process.exit(1);
  }

  const pair = argv[2];
  if (!pair || !pair.includes("=")) {
    console.error("Missing KEY=value");
    process.exit(1);
  }
  const idx = pair.indexOf("=");
  const key = pair.slice(0, idx);
  const value = pair.slice(idx + 1);

  const store = readStore();
  store.apps[app] ??= { secrets: {} };
  store.apps[app].secrets[key] = value;
  writeStore(store);
  process.exit(0);
}

if (argv[0] === "secrets" && argv[1] === "unset") {
  const app = resolveApp(argv);
  if (!app) {
    console.error("No app specified");
    process.exit(1);
  }

  const key = argv[2];
  if (!key) {
    console.error("Missing key");
    process.exit(1);
  }

  const store = readStore();
  store.apps[app] ??= { secrets: {} };
  if (!Object.prototype.hasOwnProperty.call(store.apps[app].secrets, key)) {
    console.error("Not found");
    process.exit(1);
  }

  delete store.apps[app].secrets[key];
  writeStore(store);
  process.exit(0);
}

console.error(`Unsupported fake fly invocation: ${argv.join(" ")}`);
process.exit(1);

function stripGlobals(args: string[]): string[] {
  const out: string[] = [];
  for (let i = 0; i < args.length; i += 1) {
    const token = args[i];
    if (!token) continue;
    if (token === "--config") {
      i += 1;
      continue;
    }
    out.push(token);
  }
  return out;
}

function resolveApp(args: string[]): string | undefined {
  const flagIndex = args.indexOf("--app");
  if (flagIndex !== -1) {
    const fromFlag = args[flagIndex + 1];
    if (typeof fromFlag === "string" && fromFlag.length > 0) {
      return fromFlag;
    }
  }

  const flyTomlPath = path.join(process.cwd(), "fly.toml");
  if (!fs.existsSync(flyTomlPath)) return undefined;
  const raw = fs.readFileSync(flyTomlPath, "utf8");
  const match = raw.match(/^\s*app\s*=\s*"([^"]+)"\s*$/m);
  if (!match) return undefined;
  return match[1];
}

function storePath(): string {
  return path.join(process.cwd(), ".better-env-test", "fly-store.json");
}

type Store = {
  apps: Record<string, { secrets: Record<string, string> }>;
};

function readStore(): Store {
  const p = storePath();
  if (!fs.existsSync(p)) return { apps: {} };
  const raw = fs.readFileSync(p, "utf8");
  const parsed = JSON.parse(raw);
  if (!isStore(parsed)) return { apps: {} };
  return parsed;
}

function writeStore(store: Store): void {
  const dir = path.dirname(storePath());
  fs.mkdirSync(dir, { recursive: true });
  fs.writeFileSync(storePath(), JSON.stringify(store, null, 2), "utf8");
}

function isStore(value: unknown): value is Store {
  if (typeof value !== "object" || value === null) return false;
  if (!("apps" in value)) return false;
  return true;
}
