#!/usr/bin/env bun
import fs from "node:fs";
import path from "node:path";

const argv = stripGlobals(process.argv.slice(2));

if (argv[0] === "--version") {
  console.log("Vercel CLI 0.0.0-test");
  process.exit(0);
}

if (argv[0] === "link") {
  ensureLinked();
  process.exit(0);
}

if (argv[0] === "env") {
  const sub = argv[1];
  if (sub === "pull") {
    const file = argv[2] ?? ".env.local";
    const environment = readFlag(argv, "--environment") ?? "development";
    const store = readStore();
    const vars = store.env[environment] ?? {};
    const content = Object.entries(vars)
      .sort(([a], [b]) => a.localeCompare(b))
      .map(([k, v]) => `${k}=${v}`)
      .join("\n");
    await fs.promises.writeFile(
      path.resolve(process.cwd(), file),
      `${content}\n`,
      "utf8",
    );
    process.exit(0);
  }

  if (sub === "add") {
    const key = argv[2];
    const environment = argv[3] ?? "development";
    if (!key) {
      console.error("Missing env var name");
      process.exit(1);
    }

    const force = argv.includes("--force");
    const stdin = await new Response(Bun.stdin.stream()).text();
    const value = stdin.replace(/\r?\n$/, "");

    const store = readStore();
    store.env[environment] ??= {};
    const exists = Object.prototype.hasOwnProperty.call(
      store.env[environment],
      key,
    );

    if (exists && !force) {
      console.error("Already exists");
      process.exit(1);
    }

    store.env[environment][key] = value;
    writeStore(store);
    process.exit(0);
  }

  if (sub === "rm") {
    const key = argv[2];
    const environment = argv[3] ?? "development";
    if (!key) {
      console.error("Missing env var name");
      process.exit(1);
    }

    const store = readStore();
    store.env[environment] ??= {};
    const exists = Object.prototype.hasOwnProperty.call(
      store.env[environment],
      key,
    );

    if (!exists) {
      console.error("Not found");
      process.exit(1);
    }

    delete store.env[environment][key];
    writeStore(store);
    process.exit(0);
  }

  if (sub === "ls") {
    const environment = argv[2] ?? "development";
    const store = readStore();
    const vars = store.env[environment] ?? {};

    console.log(`Environment Variables (${environment})`);
    console.log("NAME  VALUE");
    for (const [k, v] of Object.entries(vars).sort(([a], [b]) =>
      a.localeCompare(b),
    )) {
      console.log(`${k}  ${v}`);
    }
    process.exit(0);
  }
}

console.error(`Unsupported fake vercel invocation: ${argv.join(" ")}`);
process.exit(1);

function stripGlobals(args: string[]): string[] {
  const out: string[] = [];
  for (let i = 0; i < args.length; i += 1) {
    const token = args[i];
    if (!token) continue;
    if (token === "--no-color") continue;
    if (token === "--scope" || token === "--token") {
      i += 1;
      continue;
    }
    out.push(token);
  }
  return out;
}

function readFlag(args: string[], name: string): string | undefined {
  const idx = args.indexOf(name);
  if (idx === -1) return undefined;
  const value = args[idx + 1];
  return typeof value === "string" && value.length > 0 ? value : undefined;
}

function ensureLinked(): void {
  const dir = path.join(process.cwd(), ".vercel");
  fs.mkdirSync(dir, { recursive: true });
  fs.writeFileSync(
    path.join(dir, "project.json"),
    JSON.stringify({ projectId: "proj_test", orgId: "org_test" }, null, 2),
    "utf8",
  );
}

function storePath(): string {
  return path.join(process.cwd(), ".better-env-test", "vercel-store.json");
}

function readStore() {
  const p = storePath();
  if (!fs.existsSync(p)) {
    return { env: {} };
  }
  const raw = fs.readFileSync(p, "utf8");
  const parsed = JSON.parse(raw);
  if (!isStore(parsed)) {
    return { env: {} };
  }
  return parsed;
}

function writeStore(store) {
  const dir = path.dirname(storePath());
  fs.mkdirSync(dir, { recursive: true });
  fs.writeFileSync(storePath(), JSON.stringify(store, null, 2), "utf8");
}

function isStore(value) {
  if (typeof value !== "object" || value === null) return false;
  if (!("env" in value)) return false;
  return true;
}
