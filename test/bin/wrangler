#!/usr/bin/env bun
import fs from "node:fs";
import path from "node:path";

const argv = stripGlobals(process.argv.slice(2));

if (argv[0] === "--version") {
  console.log("wrangler/0.0.0-test");
  process.exit(0);
}

if (argv[0] === "secret" && argv[1] === "list") {
  const environment = readEnvironment(argv);
  const store = readStore();
  const vars = store.env[environment] ?? {};
  const out = Object.keys(vars)
    .sort((a, b) => a.localeCompare(b))
    .map((name) => ({ name, type: "secret_text" }));
  console.log(JSON.stringify(out, null, 2));
  process.exit(0);
}

if (argv[0] === "secret" && argv[1] === "put") {
  const key = argv[2];
  const environment = readEnvironment(argv);
  if (!key) {
    console.error("Missing secret key for put");
    process.exit(1);
  }

  const value = fs.readFileSync(0, "utf8").replace(/\r\n?/g, "\n").trimEnd();

  const store = readStore();
  store.env[environment] ??= {};
  store.env[environment][key] = value;
  writeStore(store);
  process.exit(0);
}

if (argv[0] === "secret" && argv[1] === "delete") {
  const key = argv[2];
  const environment = readEnvironment(argv);
  if (!key) {
    console.error("Missing secret key for delete");
    process.exit(1);
  }

  const store = readStore();
  store.env[environment] ??= {};
  const exists = Object.prototype.hasOwnProperty.call(store.env[environment], key);
  if (!exists) {
    console.error("Not found");
    process.exit(1);
  }

  delete store.env[environment][key];
  writeStore(store);
  process.exit(0);
}

console.error(`Unsupported fake wrangler invocation: ${argv.join(" ")}`);
process.exit(1);

function stripGlobals(args: string[]): string[] {
  const out: string[] = [];
  for (let i = 0; i < args.length; i += 1) {
    const token = args[i];
    if (!token) continue;

    if (token === "--config") {
      i += 1;
      continue;
    }

    out.push(token);
  }
  return out;
}

function readEnvironment(args: string[]): string {
  const idx = args.indexOf("--env");
  if (idx === -1) return "production";
  const value = args[idx + 1];
  if (typeof value !== "string" || value.length === 0) {
    return "production";
  }
  return value;
}

function storePath(): string {
  return path.join(process.cwd(), ".better-env-test", "wrangler-store.json");
}

function readStore(): Store {
  const p = storePath();
  if (!fs.existsSync(p)) {
    return { env: {} };
  }
  const raw = fs.readFileSync(p, "utf8");
  const parsed = JSON.parse(raw);
  if (!isStore(parsed)) {
    return { env: {} };
  }
  return parsed;
}

function writeStore(store: Store): void {
  const dir = path.dirname(storePath());
  fs.mkdirSync(dir, { recursive: true });
  fs.writeFileSync(storePath(), JSON.stringify(store, null, 2), "utf8");
}

type Store = {
  env: Record<string, Record<string, string>>;
};

function isStore(value: unknown): value is Store {
  if (typeof value !== "object" || value === null) return false;
  if (!("env" in value)) return false;
  return true;
}
